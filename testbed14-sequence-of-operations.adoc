== Sequence of deployment and execution operations

=== Summary

This section provides the steps of the sequence of operations required for deploying and executing both applications and workflows:

1. Alice deploys a newly developed application
2. Alice's sister discovers the new application and builds a workflow including that application.
3. Alice's sister deploys the workflow.
4. Bob discovers the new workflow and executes it.

The execution of workflow or an application on the EMS internally includes the following steps:

[start=5]
5. EO Image Discovery.
6. Deployment on ADES.
7. Execution on ADES.

Note that the security, quoting, and billing aspects are not covered here as they belong to the scope of the D010 Engineering Report. 

=== Sequence

The sequence of operations is shown on the diagram below.

image::testbed14-sequence.png[]

The execution of the application (step 1') is not covered explicitely as the steps (steps 5, 6 and 7) are similar to the execution of the workflow excepted that the EMS is only a broker in front of the ADES.

=== 1. Application deployment

Alice developed an application identified as 'MultiSensorNDVI'. She wants to make this application available to the users of the Thematic Exploitation Platform.

Using the EMS Client, Alice performs a Deployment request (step 1). The WPS-T REST HTTP POST operation path is _/processes_ , and the request message includes the following items:

* The Process Description: a standard (WPS) description of the application interface used by the client. In particular, it includes a project-specific flag (EOImage) for Earth Observation Image inputs, and it also references a CWL file providing information on the Docker image of the application. 
* The Execution Unit: the application binaries, packages and resources which is, in this case, a reference to the Docker image.
* The identifier of the Profile (in this case, a Dockerized application).

[source,json]
----
{
    "processDescription": {
        "process": {
            "id": "NDVIMultiSensor",
            "title": "NDVIMultiSensor",
            "owsContext": {
                "offering": {
                    "code": "http://www.opengis.net/eoc/applicationContext/cwl",
                    "content": {
                        "href": "https://some-host/CWL/NDVIMultiSensor.cwl"
                    }
                }
            },
            "abstract": "Normalized Difference Vegetation Index (NDVI) from an input list of satellite images.",
            "keywords": ["NDVI"],
            "inputs": [
                {
                    "id": "files",
                    "title": "Input Image",
                    "formats": [
                        {
                            "mimeType": "application/zip",
                            "default": true
                        },{
                            "mimeType": "application/x-hdf"
                        }
                    ],
                    "minOccurs": "1",
                    "maxOccurs": "unbounded",
                    "additionalParameters": [
                        {
                            "role": "http://www.opengis.net/eoc/applicationContext/inputMetadata",
                            "parameters": [
                                {
                                    "name": "EOImage",
                                    "values": ["true"]
                                }
                            ]
                        }
                    ]
                }
            ],
            "outputs": [
                {
                    "id": "output",
                    "title": "NDVI Images",
                    "formats": [
                        {
                            "mimeType": "image/tiff",
                            "default": true
                        }
                    ]
                }
            ]
        },
        "processVersion": "1.0.0",
        "jobControlOptions": [
            "async-execute"
        ],
        "outputTransmission": [
            "reference"
        ]
    },
    "immediateDeployment": true,
    "executionUnit": [{
            "href": "docker.registry/ndvims:latest"
        }],
    "deploymentProfileName": "http://www.opengis.net/profiles/eoc/dockerizedApplication"
}
----

The client then receives an acknowledgment of the successful deployment of the process as illustrated below.

[source,json]
----
{
  "processSummary": {
    "id": "MultiSensorNDVI",
    "title": "Multi Sensor NDVI",
    "abstract": "NDVI is calculated after the two bands values Near Infrared and red. It is calculated by this formula : NDVI = (NIR-Red)/(NIR+Red)",
    "keywords": [
      "NDVI"
    ],
    "version": "1.0.0",
    "jobControlOptions": [
      "async-execute"
    ],
    "processDescriptionURL": "http://some.domain/wps/processes/MultiSensorNDVI"
  }
}
----


=== 2. Application discovery and workflow design

Alice's sister is preparing a processing chain workflow. She first needs to discover the applications available on the Thematic Exploitation Platform (step 2). 
The EMS Client can list a summary of the available processes. 

The WPS-T REST HTTP GET operation path is _/processes_ and the response is illustrated below.

[source,json]
----
{
  "processes": [
    {
      "id": "NDVIMultiSensor",
      "title": "NDVIMultiSensor",
      "jobControlOptions": [
        "async-execute"
      ],
      "outputTransmission": [
        "reference"
      ],
      "processDescriptionURL": "http://185.52.193.7/wps-proxy/processes/GeomatysNDVIMultiSensor"
    },
    {
      "id": "NDVIStacker",
[...]
  ]
}
----

The chosen language for the workflow is CWL. Therefore, for each application that Alice plans to include, the CWL file of the application needs to be retrieved by the client using a description process operation.

The WPS-T REST HTTP GET operation path is _/processes/{processId}_ and the response illustrated below includes the CWL reference which was provided in the OWS Context element during deployment.

[source,json]
----
{
  "process": {
    "id": "NDVIMultiSensor",
    "title": "NDVIMultiSensor",
    "abstract": "Normalized Difference Vegetation Index (NDVI) from an input list of satellite images.",
    "owsContext": {
      "offering": {
        "code": "http://www.opengis.net/eoc/applicationContext/cwl",
        "content": {
          "href": "https://some-host/CWL/NDVIMultiSensor.cwl"
        }
      }
    },
 [...]
  },
  "processVersion": "1.0.0",
  "jobControlOptions": [
    "async-execute"
  ],
  "outputTransmission": [
    "reference"
  ]
}
----

Note that the input and output description parts have been hidden from the example and will be covered in the workflow execution step (step 4).

Alice's sister can compose her CWL workflow using her prefered CWL workflow designer tool (e.g. Rabix Composer) and import the various applications CWL files for building the workflow steps.

Before deploying the workflow generated by the design tool, the run property must be verified to ensure that:

* The CWL file path should be resticted to the file name.
* The CWL file name must be to process identifier (defined in the WPS Process Description).


[source,json]
----
   "steps":{  
      "myOwnStep":{  
         "run":"NDVIMultiSensor.cwl",
         "in":{  
            "files":"myWorkflowInput"
         },
         "out":[  
            "myOutput"
         ]
      },
----



=== 3. Workflow Deployment

Alice's sister composed the Multi Sensor NDVI Stack Generator processing chain. The chain performs a Multi Sensor NDVI processing on each of the 3 received EO Image inputs then Stack the generated outputs, as illustrated on the diagram below.

image::multisensorNDVIworkflow.png[]

Alice's sister prepares the WPS Process Description for deploying the processing chain workflow, and uses the client to perform the deployment request. The WPS-T REST HTTP POST operation path is _/processes_ and the request is shown below.

[source,json]
----
{
    "processDescription": {
        "process": {
            "id": "MultiSensorNDVIStackGenerator",
            "title": "MultiSensorNDVIStackGenerator",
            "abstract": "",
            "keywords": [],
            "inputs": [
                {
                    "id": "image-collection1",
                    "title": "Input Image",
                    "formats": [
                        {
                            "mimeType": "application/zip",
                            "default": true
                        }
                    ],
                    "minOccurs": 1,
                    "maxOccurs": "unbounded",
                    "additionalParameters": [
                        {
                            "role": "http://www.opengis.net/eoc/applicationContext/inputMetadata",
                            "parameters": [
                                {
                                    "name": "EOImage",
                                    "values": [
                                        "true"
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": "image-collection2",
                    [...]
                },
                {
                    "id": "image-collection3",
                    [...]
                } 
            ],
            "outputs": [
                {
                    "id": "output",
                    "title": "Stacked Image",
                    "formats": [
                        {
                            "mimeType": "image/tiff",
                            "default": true
                        }
                    ]
                }
            ]
        },
        "processVersion": "1.0.0",
        "jobControlOptions": [
            "async-execute"
        ],
        "outputTransmission": [
            "reference"
        ]
    },
    "executionUnit": [
        {
            "href": "https://some-host/CWL/MultiSensorStackGenerator.cwl"
        }
    ],
    "deploymentProfileName": "http://www.opengis.net/profiles/eoc/workflow"
}
----

The client receives a similar deployment confirmation message as described earlier.

=== 4. Workflow Execution

Bob tries to discover the applications and workflows available on the Thematic Exploitation Platform in order to perform an execution (step 4). The EMS Client can list the available processes using the _/processes_ REST path as already mentioned earlier.

When a WPS Process Description is requested by the EMS client, the returned document differs from the one that was submitted by Alice. Indeed, the description of EO Image input is replaced by fields required to perform a OpenSearch Catalog query. The EMS is responsible to retrieve the EO Image references by performing a Catalog search and pass the returned products URLs. Therefore, the process description returned by the EMS looks as illustrated below.

The WPS-T REST HTTP GET operation path is _/processes/{processId}_ and the response is displayed below. In that example, the inputs _image-collection1_, _image-collection2_, and _image-collection3_ were replace by the fields os_aoi, os_startDate, os_endDate, and 3 other inputs for the collection identifier.

[source,json]
----
{
  "process": {
    "id": "MultiSensorNDVIStackGenerator",
    "title": "MultiSensorNDVIStackGenerator",
    "abstract": "",
    "owsContext": {
      "offering": {
        "code": "http://www.opengis.net/eoc/applicationContext/cwl",
        "content": {
          "href": "https://some-host/multiSensorNDVIStacker.cwl"
        }
      }
    },
    "inputs": [
      {
        "id": "os_collectionId_image-collection1",
        [...]
      },
      {
        "id": "os_collectionId_image-collection2",
        [...]
      },
      {
        "id": "os_collectionId_image-collection3",
        [...]
      },
      {
        "id": "os_startDate",
        [...]
      },
      {
        "id": "os_endDate",
        [...]
      },
      {
        "id": "os_aoi"
        [...]
      }
    ],
 [...]
  }
}

----

Bob execute the workflow by submitting an execute request. The WPS-T REST HTTP POST operation path is _/processes/{processId}/jobs_

[source,json]
----
{
  "mode": "async",
  "response": "document",
  "inputs": [
    {
      "id": "os_collectionId_image-collection1",
      "data": "EOP:IPT:Sentinel2"
    },
    {
      "id": "os_collectionId_image-collection2",
      "data": "urn:ogc:def:EOP:VITO:PROBAV_P_V001"
    },
    {
      "id": "os_collectionId_image-collection2",
      "data": "DE2_MS4_L1B"
    },
    {
      "id": "os_aoi",
      "data": "100.4,18.3,104.6,19.3"
    },
    {
      "id": "os_startDate",
      "data": "2018-01-30T00:00:00.000Z"
    },
    {
      "id": "os_endDate",
      "data": "2018-01-31T23:00:59.000Z"
    }
  ],
  "outputs": [
    {
      "id": "output",
      "transmissionMode": "reference"
    }
  ]
}
----

The execution is confirmed by an HTTP 201 response code, and includes the status document URL in the "Location" HTTP header.

 The WPS-T REST HTTP GET operation path is _/processes/_{processId}_/jobs/{jobId}_.  The status shall be polled until the state is succeeded (or failed) as shown below.

[source,json]
----
{
"status":"succeeded",
"message":"Status of job 35efcdb8-7447-46bb-8338-2e706d1cfece",
"jobId":"35efcdb8-7447-46bb-8338-2e706d1cfece"
}
----

For retrieving the Result document, the WPS-T REST HTTP GET operation path is _/processes/_{processId}_/jobs/{jobId}/result_. Typically the result outputs are provided by reference to avoid retrieving files to the EMS between all the steps.

[source,json]
----
{  
   "outputs":[  
      {  
         "mimeType":"image/tiff",
         "href":"http://some-host/WPS/xxxYYY",
         "id":"output"
      }
   ]
}
----


=== 5. OpenSearch Catalog

As mentioned above, EO Image inputs are replaced by OpenSearch query fields (collection identifier, area of interest and time of interest) which are used by the EMS for searching the products URLs upon a Catalog. 

In the context of Testbed 14, the OpenSearch Gateway developed by Spacebel is based on the specification OGC OpenSearch Extension for Earth Observation 13-026r8. The Gateway is in front of the three MEP catalogs and is configured with the following collections:

* EOP:IPT:Sentinel2
* urn:ogc:def:EOP:VITO:PROBAV_P_V001
* DE2_PS3_L1C
* PROBAV_S1-TOA_1KM_V001


The first steps for retrieving EO Image references is to search for the provided collection. The collection identifier is supplied in the WPS-T REST HTTP GET operation path _http://geo.spacebel.be/opensearch/request?uid={collectionId}_.

The operation returns the list of collection entries matching with this collection identifier. For each entry, it includes a reference to the OpenSearch document that describes the collection search engine in atom:feed/atom:link[@rel=’search’][@type=‘application/opensearchdescription+xml‘].

The EMS then retrieves the OpenSearch Description Document (OSDD) for the requested collection. In the context of Testbed 14, the first step can be skipped, because the OSDD reference may be retrieved using the WPS-T REST HTTP GET operation path _http://geo.spacebel.be/opensearch/description.xml?parentIdentifier={collectionId}_.

The Collection OSDD document defines in particular the search template for the product query request in atom:entry/atom:link[@rel=’search’] with @type=’application/atom+xml’, as illustrated below.

[source,xml]
----
<Url indexOffset="1" pageOffset="1" rel="results" template="http://geo.spacebel.be/opensearch/request?httpAccept=application%2Fatom%2Bxml&amp;parentIdentifier=EOP:SSARA&amp;query={searchTerms?}&amp;startDate={time:start?}&amp;endDate={time:end?}&amp;geometry={geo:geometry?}&amp;platform={eo:platform?}&amp;orbitNumber={eo:orbitNumber?}&amp;frame={eo:frame?}&amp;sensorMode={eo:sensorMode?}&amp;swathIdentifier={eo:swathIdentifier?}&amp;orbitDirection={eo:orbitDirection?}&amp;antennaLookDirection={eo:antennaLookDirection?}&amp;polarisationChannels={eo:polarisationChannels?}&amp;processingLevel={eo:processingLevel?}&amp;maximumRecords={count?}&amp;uid={geo:uid?}&amp;name={geo:name?}&amp;lat={geo:lat?}&amp;lon={geo:lon?}&amp;radius={geo:radius?}&amp;recordSchema={sru:recordSchema?}&amp;bbox={geo:box?}&amp;startRecord={startIndex?}&amp;strict=true" type="application/atom+xml">		
----

The EMS builds the product search request path from the template by setting null values for unused fields and by setting the following parameter values:

* geo:box : AOI
* time:start : TOI start date
* time:end : TOI end date

The WPS-T REST HTTP GET operation path may look similar to

....
http://geo.spacebel.be/opensearch/request?parentIdentifier={collectionId}&startDate={toi_start}&endDate={toi_end}&bbox={aoi}&httpAccept=application/atom%2Bxml
....

Finally, the returned document is a list of entries that include as shown below:
* The link to the products: in atom:entry/atom:link[@rel=`enclosure`]
* The associated WPS endpoint: in atom:entry/owc:offering/owc:operation[@code=`Execute`]/@href

[source,xml]
----
<link href="http://landsat-ds.eo.esa.int/products/LANDSAT_ETM/2000/01/23/LS07_RMPS_ETM_GTC_1P_20000123T111514_20000123T111543_004119_0205_0038_EBB6.ZIP" rel="enclosure" title="Download" type="application/x-binary"/>
<owc:offering code="http://www.opengis.net/spec/owc-atom/1.0/req/wps">
			<owc:operation method="GET" code="Execute" type="application/xml" href="http://wps-domain/WPS/endpoint"/>
</owc:offering> 
---- 

The execution of the WPS Process pointed by the workflow step that consumes the EO Image needs to be performed on the MEP ADES associated with the EO Image. This ensures that the Process will be executed close to the EO Image data location. 


=== 5. EMS Deployment on ADES

EMS deploys the Application(s). The deployment request is based  on the document provided on step 1 by Alice. It also embbeds in the Process Description (inside the ows:AdditionalParameters element) the information provided by the CWL file. Note that this duplicates the information in the request, but this agreement was adopted as a compromise between the different implementation approaches.

The MultiSensorNDVI deployment request sent to the ADES is shown below. 

[source,json]
----
{
    "processOffering": {
        "process": {
            "id": "MultiSensorNDVI",
            "title": "Multi Sensor NDVI",
            "abstract": "NDVI is calculated after the two bands values Near Infrared and red. It is calculated by this formula : NDVI = (NIR-Red)/(NIR+Red)",
            "keywords": [
                "NDVI"
            ],
            "owsContext": {
                "offering": {
                    "code": "http://www.opengis.net/eoc/applicationContext/cwl",
                    "content": {
                        "href": "http://some.host/CWL/MultiSensorNDVI.cwl"
                    }
                }
            },
            "inputs": [
                {
                    "id": "inputImage",
                    "title": "Input Image",
                    "formats": [
                        {
                            "mimeType": "application/zip",
                            "default": true
                        }
                    ],
                    "minOccurs": 1,
                    "maxOccurs": 1,
                    "additionalParameters": [
                        {
                            "role": "http://www.opengis.net/eoc/applicationContext/cwl",
                            "parameters": [
                                {
                                    "name": "position",
                                    "value": "1"
                                },
                                {
                                    "name": "prefix",
                                    "value": "image"
                                },
                                {
                                    "name": "separate",
                                    "value": "false"
                                },
                                {
                                    "name": "itemSeparator",
                                    "value": "="
                                }
                            ]
                        }
                    ],
                    "owsContext": {
                        "offering": {
                            "code": "anyCode",
                            "content": {
                                "href": "anyRef"
                            }
                        }
                    }
                },
[...]    },
    "deploymentProfile": {
        "deploymentProfileName": "http://www.opengis.net/profiles/eoc/dockerizedApplication",
        "executionUnit": {
            "reference": "docker.registry.host/multisensorNDVI"
        }
    }
}
----

The client receives a similar deployment confirmation message as described earlier.

image::https://upload.wikimedia.org/wikipedia/commons/thumb/b/bd/France_road_sign_AB4.svg/375px-France_road_sign_AB4.svg.png[Stop]
=== 6. EMS Execution on ADES

* EMS sends an execute request to ADES "MultiSensorNDVI" process on behalf of Bob with Bob input parameters and the Catalog search results products.
....
  curl -X POST \
       -i "http://some.host/WPS/processes/MultiSensorNDVI/jobs" \
       -H "Authorization: Bearer Th34cc3ssTok3nFromBob"
       -d "@5-execute.json"
....

The request in JSON:
[source,json]
----
{
  "inputs": [
    {
      "id": "image",
      "reference": "http://landsat.host/productXXX.zip"
    },
    {
      "id": "inputParameter",
      "value": "myParameterValue"
    }
  ],
  "outputs": [
    {
      "id": "ndviOut",
      "transmissionMode": "REFERENCE"
    }
  ]
}
----

* ADES checks from the Access Token that the requester has rights to execute the process
* ADES assigns a jobId "ades_exec001" for the execution and returns an acknowledgment to EMS
* EMS links "ades_exec001" job to "ems_exec001" job
* ADES runs the CWL file with input json file
....
cwl-runner MultiSensorNDVI.cwl 6-NDVI-params.json
....

==== Others 

TODO: the workflow part looks very similar to the other steps, but the examples are not created yet.

* Alice deploys the Workflow. For the WPS-T encoding, the <ExecutionUnit> part is not the Docker Image anymore but the workflow CWL (example not yet ready). The Process Description includes EO Image input. In the DescribeProcess response, the EMS also generates a Descripiton with the corresponding OpenSearch Gateway inputs (this step is missing on the diagram).

* Bob invokes the WPS 2.0 Execute operation (encoding XML or JSON). The inputs includes the OpenSearch Gateway inputs (i.e. CollectionId, AOI, TOI).

* EMS internally performs the OpenSearch gateway search of products to retrieve the list of products URLs. Based on the CollectionId from the request inputs, EMS also selects the relevant MEP.

* EMS deploys the Application(s) (using the original Process Description, not the generated one). Same format and encoding as step 1. The target MEP is selected based on CollectionId.

* EMS invokes the WPS 2.0 Execute operation (encoding XML or JSON) on the workflow. The inputs includes the OpenSearch results URLs.

* The workflow executes the Application on the relevant MEP.


